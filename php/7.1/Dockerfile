FROM xutongle/dependent:latest

ENV DEBIAN_FRONTEND noninteractive

MAINTAINER XUTONGLE <xutongle@gmail.com>

ENV PHP_INSTALL_DIR=/usr/local \
    PHP_VERSION=7.1.1 \
    REDIS_PECL_VERSION=3.1.1 \
    MEMCACHED_PECL_VERSION=3.0.0 \
    SWOOLE_VERSION=2.0.6 \
    COMPOSER_HASH="55d6ead61b29c7bdee5cccfb50076874187bd9f21f65d8991d46ec5cc90518f447387fb9f76ebae1fbbacf329e583e30"

WORKDIR /tmp

# install php
RUN wget -c --no-check-certificate https://xutl.oss-cn-hangzhou.aliyuncs.com/docker-asset/php/php-${PHP_VERSION}.tar.gz && \
    tar xzf php-${PHP_VERSION}.tar.gz && \
    cd php-$PHP_VERSION && \
    ./configure --prefix=$PHP_INSTALL_DIR \
        --with-config-file-path=$PHP_INSTALL_DIR/etc \
        --with-config-file-scan-dir=$PHP_INSTALL_DIR/etc/php.d \
        --mandir=$PHP_INSTALL_DIR/share/man \
        --infodir=$PHP_INSTALL_DIR/share/info \
        --sysconfdir=$PHP_INSTALL_DIR/etc \
        --with-fpm-user=$RUN_USER \
        --with-fpm-group=$RUN_USER \
        --with-libxml-dir --with-openssl --with-kerberos \
        --with-zlib --enable-bcmath --with-bz2 \
        --enable-calendar --with-curl --enable-exif \
        --enable-fpm --enable-ftp --with-png-dir \
        --with-gd --with-jpeg-dir --enable-gd-native-ttf --with-icu-dir=/usr --enable-mbstring --enable-mbregex \
        --enable-shmop --enable-soap --enable-sockets --enable-sysvmsg --enable-sysvsem --enable-sysvshm \
        --enable-wddx --with-xmlrpc --with-libedit --with-iconv-dir --with-xsl --enable-zip \
        --with-pcre-regex --with-freetype-dir --enable-xml  --with-mysqli=mysqlnd --with-pdo-mysql=mysqlnd \
        --with-pdo-sqlite --with-sqlite3 --disable-rpath --enable-inline-optimization \
        --with-mcrypt --with-mhash --enable-pcntl --enable-sockets --without-pear \
        --with-gettext --enable-fileinfo --enable-intl \
        --enable-opcache --enable-cli  --disable-debug && \
    make ZEND_EXTRA_LIBS='-liconv' && \
    make install && \
    mkdir -p $PHP_INSTALL_DIR/etc/php.d && \
    /bin/cp php.ini-production $PHP_INSTALL_DIR/etc/php.ini && \
    rm -rf /tmp/*

# install php-memcached
RUN git clone https://github.com/php-memcached-dev/php-memcached -b php7 && \
    cd php-memcached/ && \
    $PHP_INSTALL_DIR/bin/phpize && \
    ./configure --with-libmemcached-dir=/usr --with-php-config=$PHP_INSTALL_DIR/bin/php-config && \
    make && make install && \
    echo "extension=memcached.so" >> $PHP_INSTALL_DIR/etc/php.d/ext-memcached.ini && \
    echo "memcached.use_sasl=1" >> $PHP_INSTALL_DIR/etc/php.d/ext-memcached.ini && \
    rm -rf /tmp/*


# install php-redis
RUN git clone https://github.com/phpredis/phpredis -b php7 && \
    cd phpredis/ && \
    $PHP_INSTALL_DIR/bin/phpize && \
    ./configure --with-php-config=$PHP_INSTALL_DIR/bin/php-config && \
    make && make install && \
    echo "extension=redis.so" > $PHP_INSTALL_DIR/etc/php.d/ext-redis.ini && \
    rm -rf /tmp/*

# install swoole
RUN wget -c --no-check-certificate http://pecl.php.net/get/swoole-${SWOOLE_VERSION}.tgz && \
    tar xzf swoole-${SWOOLE_VERSION}.tgz && \
    cd swoole-${SWOOLE_VERSION} && \
    $PHP_INSTALL_DIR/bin/phpize && \
    ./configure --with-php-config=$PHP_INSTALL_DIR/bin/php-config --enable-jemalloc && \
    make && make install && \
    echo "extension=swoole.so" > $PHP_INSTALL_DIR/etc/php.d/ext-swoole.ini && \
    rm -rf /tmp/*

# install composer
RUN php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');" && \
  php -r "if (hash_file('SHA384', 'composer-setup.php') === '${COMPOSER_HASH}') { echo 'Installer verified'; } else { echo 'Installer corrupt'; unlink('composer-setup.php'); } echo PHP_EOL;" && \
  php composer-setup.php --install-dir=/usr/local/bin --filename=composer && \
  php -r "unlink('composer-setup.php');"

##<autogenerated>##

# install nginx
RUN apt-key adv --keyserver keyserver.ubuntu.com --recv-keys ABF5BD827BD9BF62 && \
    echo "deb http://www.nginx.org/packages/debian/ jessie nginx" > /etc/apt/sources.list.d/nginx.list && \
    apt-get update && \
    apt-get install -y nginx && \
    apt-get clean && \
    echo -n > /var/lib/apt/extended_states

RUN usermod -u 1000 www-data

###</autogenerated>##

ADD php.ini /usr/local/etc/php/php.ini
ADD php-fpm.conf /usr/local/etc/php-fpm.conf
ADD nginx.conf /etc/nginx/nginx.conf
ADD fastcgi.conf /etc/nginx/fastcgi.conf
ADD supervisord-*.conf /etc/supervisor/conf.d/

# Define the default command.
CMD ["/bin/bash"]
#CMD ["/run.sh"]